<!-- Added JS Filter Bar -->
<div>
  <p>Filter by</p>
  <div class="filter-container d-flex gap-3">
    <input type="text" id="teamFilter" placeholder="Filter by team">
    <input type="text" id="instructorFilter" placeholder="Filter by instructor">
    <input type="date" id="dateFilter" placeholder="Filter by start date">
  </div>
</div>

{% for team, team_cohorts in cohorts|groupby('team.name') %}
  <div class="cohort-group">
    <h2 class="team-name">Team: {{ team if team else "No Team" }}</h2>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Max Capacity</th>
          <th>Description</th>
          <th>Primary Instructor</th>
          <th>Secondary Instructor</th>
          <th>Start Date</th>
          <th>Number of Days</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for cohort in team_cohorts %}
          {% if cohort.start_date < now %}
        <tr class="cohort-row">
          <td>
            <span class="editable" data-id="{{ cohort.id }}" data-column-name="name" data-route="{{ url_for('base_routes.update', model_name='cohort') }}">{{ cohort.name }}</span>
          </td>
          <td>
            <span class="editable" data-id="{{ cohort.id }}" data-column-name="max_capacity" data-route="{{ url_for('base_routes.update', model_name='cohort') }}">{{ cohort.max_capacity }}</span>
          </td>
          <td>
            <span class="editable" data-id="{{ cohort.id }}" data-column-name="description" data-route="{{ url_for('base_routes.update', model_name='cohort') }}">
              {% if cohort.description %}
                {{ cohort.description }}
              {% else %}
                No Description
              {% endif %}
            </span>
          </td>
          <td>
            {% if cohort.primary_instructor_id %}
              {{ cohort.primary_instructor.name }}
            {% else %}
              {% if cohort.team and cohort.team.instructors %}
                <form method="post" action="{{ url_for('cohorts.assign_instructor', id=cohort.id, role='primary') }}">
                  <select name="instructor_id">
                    {% for instructor in cohort.team.instructors %}
                      <option value="{{ instructor.id }}">{{ instructor.name }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn">Assign</button>
                </form>
              {% else %}
                No Instructors Available
              {% endif %}
            {% endif %}
          </td>
          <td>
            {% if cohort.secondary_instructor %}
              {{ cohort.secondary_instructor.name }}
            {% else %}
              {% if cohort.team and cohort.team.instructors %}
                <form method="post" action="{{ url_for('cohorts.assign_instructor', id=cohort.id, role='secondary') }}">
                  <select name="instructor_id">
                    {% for instructor in cohort.team.instructors %}
                      <option value="{{ instructor.id }}">{{ instructor.name }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn">Assign</button>
                </form>
              {% else %}
                No Instructors Available
              {% endif %}
            {% endif %}
          </td>
          <td>
            <span class="editable" data-id="{{ cohort.id }}" data-column-name="start_date" data-route="{{ url_for('base_routes.update', model_name='cohort') }}">{{ cohort.start_date }}</span>
          </td>
          <td>
            <span class="editable" data-id="{{ cohort.id }}" data-column-name="number_of_days" data-route="{{ url_for('base_routes.update', model_name='cohort') }}">{{ cohort.number_of_days }}</span>
          </td>
          <td>
            <a class="btn" href="{{ url_for('cohorts.delete', id=cohort.id) }}">Delete</a>
          </td>
        </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endfor %}

<!-- Added inline JS for filtering -->
<script>
  const teamFilter = document.getElementById("teamFilter");
  const instructorFilter = document.getElementById("instructorFilter");
  const dateFilter = document.getElementById("dateFilter");

  function filterCohorts() {
    const teamVal = teamFilter.value.toLowerCase();
    const instructorVal = instructorFilter.value.toLowerCase();
    const dateVal = dateFilter.value; // assuming yyyy-mm-dd

    document.querySelectorAll(".cohort-group").forEach(group => {
      const teamName = group.querySelector(".team-name").textContent.toLowerCase();
      // Filter group by team name
      const teamMatch = !teamVal || teamName.indexOf(teamVal) !== -1;

      // Filter each row in the group
      let anyVisible = false;
      group.querySelectorAll(".cohort-row").forEach(row => {
        const rowText = row.textContent.toLowerCase();
        // Check instructor filter
        const instructorMatch = !instructorVal || rowText.indexOf(instructorVal) !== -1;
        // Check date filter (simple substring match for date format)
        const dateMatch = !dateVal || rowText.indexOf(dateVal) !== -1;

        if (instructorMatch && dateMatch && teamMatch) {
          row.style.display = "";
          anyVisible = true;
        } else {
          row.style.display = "none";
        }
      });

      // Hide group if team filter mismatch or no matching rows
      group.style.display = (teamMatch && anyVisible) ? "" : "none";
    });
  }

  teamFilter.addEventListener("input", filterCohorts);
  instructorFilter.addEventListener("input", filterCohorts);
  dateFilter.addEventListener("input", filterCohorts);
</script>
